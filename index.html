<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Daybook — Modern Diary</title>
    <meta name="color-scheme" content="light dark" />
    <style>
      :root {
        --bg: #0b0e14;
        --surface: #111827;
        --surface-2: #0f172a;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --ring: #60a5fa55;
        --primary: #60a5fa;
        --primary-600: #3b82f6;
        --accent: linear-gradient(135deg, #60a5fa, #8b5cf6);
        --shadow: 0 10px 30px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.25);
        --radius: 14px;
        --card-blur: saturate(140%) blur(6px);
      }
      [data-theme="light"] {
        --bg: #f7f8fb;
        --surface: #ffffff;
        --surface-2: #eef2ff;
        --text: #0f172a;
        --muted: #6b7280;
        --ring: #60a5fa55;
        --primary: #2563eb;
        --primary-600: #1d4ed8;
        --accent: linear-gradient(135deg, #2563eb, #7c3aed);
        --shadow: 0 8px 28px rgba(2,6,23,.08), 0 2px 10px rgba(2,6,23,.06);
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--text);
        background:
          radial-gradient(1200px 600px at 15% -10%, rgba(99,102,241,.15), transparent 50%),
          radial-gradient(1000px 800px at 110% -10%, rgba(59,130,246,.18), transparent 50%),
          var(--bg);
      }

      .app {
        display: grid;
        grid-template-rows: auto 1fr;
        min-height: 100vh;
      }

      /* Top bar */
      .topbar {
        position: sticky; top: 0; z-index: 20;
        backdrop-filter: var(--card-blur);
        background: color-mix(in srgb, var(--surface) 80%, transparent);
        border-bottom: 1px solid color-mix(in srgb, var(--muted) 20%, transparent);
      }
      .topbar-inner {
        display: grid;
        grid-template-columns: 240px 1fr auto;
        gap: 16px;
        padding: 14px clamp(14px, 4vw, 28px);
        align-items: center;
      }
      .brand {
        display: flex; align-items: center; gap: 10px;
        font-weight: 700; letter-spacing: .2px; font-size: 16px;
      }
      .brand .logo {
        width: 28px; height: 28px; border-radius: 10px;
        background: var(--accent);
        box-shadow: inset 0 1px 0 rgba(255,255,255,.25), 0 8px 18px rgba(99,102,241,.35);
      }
      .today {
        font-size: 12px; color: var(--muted);
      }

      .searchbar { position: relative; }
      .searchbar input {
        width: 100%;
        background: var(--surface);
        color: var(--text);
        border: 1px solid color-mix(in srgb, var(--muted) 22%, transparent);
        box-shadow: var(--shadow);
        padding: 12px 40px 12px 40px; border-radius: 999px;
        outline: none;
      }
      .searchbar svg { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); opacity: .7; }
      .searchbar kbd { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); opacity: .6; font-size: 11px; padding: 2px 6px; border-radius: 6px; border: 1px solid color-mix(in srgb, var(--muted) 30%, transparent); }

      .actions { display: flex; align-items: center; gap: 10px; }
      .btn {
        display: inline-flex; align-items: center; gap: 8px; justify-content: center;
        height: 36px; padding: 0 14px; border-radius: 10px; cursor: pointer; user-select: none;
        background: var(--surface); color: var(--text);
        border: 1px solid color-mix(in srgb, var(--muted) 22%, transparent);
        box-shadow: var(--shadow);
        transition: transform .05s ease, background .2s ease, border-color .2s ease;
      }
      .btn:hover { border-color: color-mix(in srgb, var(--primary) 45%, transparent); }
      .btn:active { transform: translateY(1px); }
      .btn.primary { background: var(--accent); color: white; border-color: transparent; }
      .btn.ghost { background: transparent; }
      .icon-btn { width: 36px; padding: 0; }

      /* Layout */
      .content {
        display: grid;
        grid-template-columns: 280px 1fr 300px;
        gap: 18px;
        padding: 18px clamp(14px, 4vw, 28px) 32px;
        align-items: start;
      }
      @media (max-width: 1200px) {
        .content { grid-template-columns: 240px 1fr 260px; }
      }
      @media (max-width: 980px) {
        .topbar-inner { grid-template-columns: 1fr auto; }
        .brand { display: none; }
        .content { grid-template-columns: 1fr; }
        .sidebar { order: 2; }
        .rightbar { order: 3; }
      }

      .panel {
        background: color-mix(in srgb, var(--surface) 90%, transparent);
        border: 1px solid color-mix(in srgb, var(--muted) 18%, transparent);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        backdrop-filter: var(--card-blur);
      }

      .sidebar { position: sticky; top: 74px; }
      .rightbar { position: sticky; top: 74px; }
      .side-section { padding: 14px 14px 8px; }
      .side-title { margin: 0 0 10px; font-size: 12px; letter-spacing: .4px; text-transform: uppercase; color: var(--muted); }
      .entry-group { margin: 8px 6px 4px; font-size: 11px; color: var(--muted); }
      .entries-list { display: grid; gap: 6px; padding: 0 6px 8px; }
      .entry-item { padding: 8px 10px; border-radius: 10px; border: 1px solid color-mix(in srgb, var(--muted) 18%, transparent); background: var(--surface); cursor: pointer; }
      .entry-item:hover { border-color: color-mix(in srgb, var(--primary) 45%, transparent); background: color-mix(in srgb, var(--primary) 10%, transparent); }
      .entry-item .t { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .entry-item .m { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--muted); }

      /* Calendar */
      .calendar { padding: 10px 14px 16px; }
      .cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
      .cal-header button { width: 28px; height: 28px; border-radius: 8px; border: 1px solid color-mix(in srgb, var(--muted) 22%, transparent); background: var(--surface); color: var(--text); cursor: pointer; }
      .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
      .cal-day, .cal-cell { text-align: center; font-size: 11px; color: var(--muted); }
      .cal-cell { padding: 8px 0; border-radius: 8px; cursor: pointer; color: var(--text); border: 1px solid transparent; }
      .cal-cell.out { opacity: .35; }
      .cal-cell.has { border-color: color-mix(in srgb, var(--primary) 40%, transparent); }
      .cal-cell.active { background: color-mix(in srgb, var(--primary) 16%, transparent); border-color: color-mix(in srgb, var(--primary) 60%, transparent); }

      /* Chips */
      .chips { display: flex; flex-wrap: wrap; gap: 8px; }
      .chip {
        display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--muted) 22%, transparent);
        background: var(--surface);
        cursor: pointer; font-size: 12px; color: var(--text);
      }
      .chip.active { border-color: color-mix(in srgb, var(--primary) 55%, transparent); background: color-mix(in srgb, var(--primary) 16%, transparent); }
      .chip .count { opacity: .6; font-variant-numeric: tabular-nums; }

      .main { padding: 8px; }
      .toolbar { display: flex; align-items: center; justify-content: space-between; margin: 0 4px 8px; }
      .toolbar .summary { color: var(--muted); font-size: 12px; }

      /* Cards */
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; }
      .card {
        position: relative; padding: 14px; border-radius: var(--radius);
        border: 1px solid color-mix(in srgb, var(--muted) 18%, transparent);
        background: color-mix(in srgb, var(--surface) 92%, transparent);
        box-shadow: var(--shadow); overflow: hidden;
      }
      .card .title { margin: 0 0 6px; font-size: 16px; font-weight: 700; }
      .card .meta { display: flex; align-items: center; gap: 8px; color: var(--muted); font-size: 12px; margin-bottom: 8px; }
      .card .body { color: color-mix(in srgb, var(--text) 85%, transparent); max-height: 5.6em; overflow: hidden; }
      .card .tags { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
      .tag-mini { font-size: 11px; padding: 4px 8px; border-radius: 999px; border: 1px solid color-mix(in srgb, var(--muted) 22%, transparent); color: var(--text); }
      .card .card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 6px; }
      .icon { width: 18px; height: 18px; opacity: .8; }
      .icon-btn.small { width: 28px; height: 28px; border-radius: 8px; }
      .pin { position: absolute; right: 12px; top: -8px; font-size: 18px; }

      /* Editor Modal */
      .modal { position: fixed; inset: 0; display: none; place-items: center; padding: 18px; z-index: 50; }
      .modal.open { display: grid; }
      .overlay { position: absolute; inset: 0; background: rgba(0,0,0,.45); backdrop-filter: blur(2px); }
      .dialog { position: relative; width: min(920px, 96vw); max-height: 92vh; overflow: hidden; border-radius: 18px; background: var(--surface); border: 1px solid color-mix(in srgb, var(--muted) 18%, transparent); box-shadow: var(--shadow); display: grid; grid-template-rows: auto 1fr auto; }
      .dialog header, .dialog footer { padding: 12px 14px; border-bottom: 1px solid color-mix(in srgb, var(--muted) 18%, transparent); }
      .dialog footer { border-top: 1px solid color-mix(in srgb, var(--muted) 18%, transparent); border-bottom: none; display: flex; gap: 8px; justify-content: flex-end; }
      .dialog .editor {
        display: grid; grid-template-columns: 1fr 280px; gap: 14px; padding: 14px; overflow: auto;
      }
      @media (max-width: 840px) { .dialog .editor { grid-template-columns: 1fr; } }
      .field { display: grid; gap: 6px; }
      .field label { font-size: 12px; color: var(--muted); }
      .field input[type="text"], .field input[type="date"], .field textarea {
        width: 100%; padding: 10px 12px; border-radius: 10px; background: var(--surface);
        border: 1px solid color-mix(in srgb, var(--muted) 22%, transparent); color: var(--text);
      }
      .contenteditable {
        min-height: 280px; padding: 12px; border-radius: 10px; background: var(--surface);
        border: 1px solid color-mix(in srgb, var(--muted) 22%, transparent); color: var(--text);
      }
      .formatbar { display: flex; gap: 6px; margin-bottom: 8px; }
      .formatbar button { width: 32px; height: 32px; border-radius: 8px; border: 1px solid color-mix(in srgb, var(--muted) 22%, transparent); background: var(--surface); color: var(--text); cursor: pointer; }
      .moods { display: flex; gap: 6px; }
      .mood { padding: 8px 10px; border-radius: 10px; border: 1px solid color-mix(in srgb, var(--muted) 22%, transparent); cursor: pointer; background: var(--surface); }
      .mood.active { border-color: color-mix(in srgb, var(--primary) 55%, transparent); background: color-mix(in srgb, var(--primary) 16%, transparent); }

      .rightcol { display: grid; gap: 12px; align-content: start; }
      .help { font-size: 12px; color: var(--muted); }

      /* Toast */
      .toast { position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%) translateY(20px); opacity: 0; transition: .25s ease; background: var(--surface); border: 1px solid color-mix(in srgb, var(--muted) 22%, transparent); padding: 10px 14px; border-radius: 999px; z-index: 60; box-shadow: var(--shadow); }
      .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

      /* Empty state */
      .empty { text-align: center; color: var(--muted); padding: 40px 20px; }

      /* Auth gate */
      .auth {
        position: fixed; inset: 0; display: none; place-items: center; padding: 20px; z-index: 100;
        background:
          radial-gradient(900px 500px at 10% -10%, rgba(99,102,241,.18), transparent 50%),
          radial-gradient(900px 600px at 110% -10%, rgba(59,130,246,.22), transparent 55%),
          rgba(2,6,23,.35);
        backdrop-filter: blur(4px);
      }
      body.locked .auth { display: grid; }
      body.locked .app { filter: blur(8px) saturate(90%); pointer-events: none; user-select: none; }
      .auth-card { width: min(460px, 96vw); padding: 16px 14px; }
      .auth-card .brand { margin-bottom: 6px; }
      .link { background: none; border: none; color: var(--primary-600); cursor: pointer; padding: 0 2px; border-radius: 6px; }
      .link:hover { text-decoration: underline; }

      /* Settings menu */
      .menu { position: relative; }
      .menu-list {
        position: absolute; right: 0; top: calc(100% + 8px);
        display: none; width: 240px; padding: 6px; border-radius: var(--radius);
        background: color-mix(in srgb, var(--surface) 94%, transparent);
        border: 1px solid color-mix(in srgb, var(--muted) 18%, transparent);
        box-shadow: var(--shadow);
        z-index: 30;
      }
      .menu.open .menu-list { display: block; }
      .menu-item { width: 100%; text-align: left; background: transparent; color: var(--text); border: none; padding: 10px 10px; border-radius: 10px; cursor: pointer; }
      .menu-item:hover { background: color-mix(in srgb, var(--primary) 12%, transparent); }
      .menu-item.danger { color: #ef4444; }
      .menu-sep { height: 1px; width: 100%; border: 0; background: color-mix(in srgb, var(--muted) 22%, transparent); margin: 6px 0; }
    </style>
  </head>
  <body class="locked">
    <!-- Icons -->
    <svg width="0" height="0" style="position:absolute">
      <defs>
        <symbol id="i-search" viewBox="0 0 24 24"><path fill="currentColor" d="M10 2a8 8 0 1 1 0 16a8 8 0 0 1 0-16m11 18.59L17.42 17A10 10 0 1 0 20 19.42L22.59 22z"/></symbol>
        <symbol id="i-plus" viewBox="0 0 24 24"><path fill="currentColor" d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol>
        <symbol id="i-sun" viewBox="0 0 24 24"><path fill="currentColor" d="M6.76 4.84L5.34 3.42L3.92 4.84l1.41 1.42M1 13h3v-2H1m10-9h-2v3h2m7.66 3.26l1.41-1.41l-1.41-1.42l-1.41 1.42M20 13h3v-2h-3M11 20h2v3h-2m7.66-3.26l1.41 1.41l1.41-1.41l-1.41-1.41M4.84 17.24L3.42 18.66l1.41 1.41l1.42-1.41M12 8a4 4 0 1 1 0 8a4 4 0 0 1 0-8"/></symbol>
        <symbol id="i-moon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a10 10 0 0 0 0 20a9.93 9.93 0 0 0 6.73-2.65A8 8 0 0 1 11 4a8 8 0 0 1 1-2z"/></symbol>
        <symbol id="i-edit" viewBox="0 0 24 24"><path fill="currentColor" d="M5 18.08V21h2.92L18.84 10.08l-2.92-2.92zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83l3.75 3.75z"/></symbol>
        <symbol id="i-trash" viewBox="0 0 24 24"><path fill="currentColor" d="M9 3v1H4v2h16V4h-5V3zm2 6h2v9h-2zm-4 0h2v9H7zm8 0h2v9h-2z"/></symbol>
        <symbol id="i-pin" viewBox="0 0 24 24"><path fill="currentColor" d="M14 12l4-4l-2-2l-4 4l-4-4l-2 2l4 4l-6 6h8z"/></symbol>
        <symbol id="i-download" viewBox="0 0 24 24"><path fill="currentColor" d="M5 20h14v-2H5m7-2l5-5h-3V4h-4v7H7z"/></symbol>
        <symbol id="i-upload" viewBox="0 0 24 24"><path fill="currentColor" d="M5 20h14v-2H5m7-10l5 5h-3v7h-4v-7H7z"/></symbol>
        <symbol id="i-close" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"/></symbol>
        <symbol id="i-bold" viewBox="0 0 24 24"><path fill="currentColor" d="M13.5 15.5H9V19H6V5h8a4 4 0 0 1 0 8h-.5zm-4.5-3h4a2 2 0 0 0 0-4H9z"/></symbol>
        <symbol id="i-italic" viewBox="0 0 24 24"><path fill="currentColor" d="M10 5v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V5z"/></symbol>
        <symbol id="i-underline" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17a5 5 0 0 0 5-5V5h-2v7a3 3 0 0 1-6 0V5H7v7a5 5 0 0 0 5 5m-7 2v2h14v-2z"/></symbol>
        <symbol id="i-list" viewBox="0 0 24 24"><path fill="currentColor" d="M3 5h2v2H3zm0 6h2v2H3zm0 6h2v2H3zM7 5h14v2H7zm0 6h14v2H7zm0 6h14v2H7z"/></symbol>
        <symbol id="i-olist" viewBox="0 0 24 24"><path fill="currentColor" d="M4 6h2V4H3v1h1zm-1 6h1.8L3 14.2V15h3v-1H4.2l1.6-2.2V11H3zm0 6h3v-1H4v-.5h1.5V15H3v3zM7 5h14v2H7zm0 6h14v2H7zm0 6h14v2H7z"/></symbol>
        <symbol id="i-link" viewBox="0 0 24 24"><path fill="currentColor" d="M3.9 12a4.1 4.1 0 0 1 4.1-4.1h4v2h-4A2.1 2.1 0 1 0 11 12a2 2 0 0 0 2 2h4v2h-4A4 4 0 0 1 3.9 12m7-1h2v2h-2zM13 10h4a2.1 2.1 0 1 1 0 4.2h-4v-2h4a.1.1 0 0 0 0-.2h-4z"/></symbol>
        <symbol id="i-calendar" viewBox="0 0 24 24"><path fill="currentColor" d="M19 4h-1V2h-2v2H8V2H6v2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2m0 16H5V10h14z"/></symbol>
        <symbol id="i-tag" viewBox="0 0 24 24"><path fill="currentColor" d="M21.41 11.58l-9-9A2 2 0 0 0 11 2H4a2 2 0 0 0-2 2v7a2 2 0 0 0 .59 1.41l9 9a2 2 0 0 0 2.82 0l7-7a2 2 0 0 0 0-2.83M6.5 8A1.5 1.5 0 1 1 8 6.5A1.5 1.5 0 0 1 6.5 8"/></symbol>
        <symbol id="i-settings" viewBox="0 0 24 24"><path fill="currentColor" d="M12 8a4 4 0 1 1 0 8a4 4 0 0 1 0-8m8.94 4.5l1.8-1.04l-1.8-3.12l-2.08.36a7.07 7.07 0 0 0-1.2-.7l-.53-2.05H9.87l-.53 2.05c-.42.18-.82.41-1.2.7l-2.08-.36L4.26 11.5l1.8 1.04c-.03.16-.03.33-.03.5s0 .34.03.5l-1.8 1.04l1.8 3.12l2.08-.36c.38.29.78.52 1.2.7l.53 2.05h6.26l.53-2.05c.42-.18.82-.41 1.2-.7l2.08.36l1.8-3.12l-1.8-1.04c.03-.16.03-.33.03-.5s0-.34-.03-.5"/></symbol>
      </defs>
    </svg>

    <!-- Auth Gate -->
    <div class="auth" id="authGate">
      <div class="auth-card panel">
        <div class="brand" style="justify-content:center; margin-bottom: 6px;">
          <div class="logo"></div>
          <div>Daybook</div>
        </div>
        <div class="help" id="authSubtitle" style="text-align:center; margin-bottom: 12px;"></div>
        <form id="loginView" style="display:none">
          <div class="field">
            <label for="loginUser">Username</label>
            <input id="loginUser" type="text" autocomplete="username" placeholder="Your username" list="usersList" />
          </div>
          <div class="field" style="margin-top:8px">
            <label for="loginPass">Password</label>
            <input id="loginPass" type="password" autocomplete="current-password" placeholder="Password" />
          </div>
          <div id="authError" style="color:#ef4444; font-size:12px; min-height: 18px; margin-top:6px"></div>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top: 10px;">
            <button type="submit" class="btn primary" id="btnSignIn">Sign In</button>
          </div>
          <div class="help" style="text-align:center; margin-top:8px">New here? <button type="button" class="link" id="goSetup">Create Account</button></div>
        </form>
        <form id="setupView" style="display:none">
          <div class="field">
            <label for="setupUser">Create Username</label>
            <input id="setupUser" type="text" autocomplete="username" placeholder="e.g., alex" />
          </div>
          <div class="field" style="margin-top:8px">
            <label for="setupPass">Create Password</label>
            <input id="setupPass" type="password" autocomplete="new-password" placeholder="At least 6 characters" />
          </div>
          <div class="field" style="margin-top:8px">
            <label for="setupPass2">Confirm Password</label>
            <input id="setupPass2" type="password" autocomplete="new-password" placeholder="Repeat password" />
          </div>
          <div id="setupError" style="color:#ef4444; font-size:12px; min-height: 18px; margin-top:6px"></div>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top: 10px;">
            <button type="submit" class="btn primary" id="btnCreate">Create Account</button>
          </div>
          <div class="help" style="text-align:center; margin-top:8px">Have an account? <button type="button" class="link" id="goLogin">Sign In</button></div>
        </form>
        <div class="help" style="margin-top:10px; text-align:center">
          Tip: This protects access to the app on this device.
        </div>
      </div>
    </div>
    <datalist id="usersList"></datalist>

    <div class="app">
      <div class="topbar">
        <div class="topbar-inner">
          <div class="brand">
            <div class="logo"></div>
            <div>
              <div>Daybook</div>
              <div class="today" id="todayLabel"></div>
            </div>
          </div>
          <div class="searchbar">
            <svg class="icon"><use href="#i-search"/></svg>
            <input id="searchInput" type="search" placeholder="Search entries, tags, or text (/ to focus)" autocomplete="off" />
            <kbd>/</kbd>
          </div>
          <div class="actions">
            <button class="btn icon-btn" id="btnImport" title="Import JSON"><svg class="icon"><use href="#i-upload"/></svg></button>
            <button class="btn icon-btn" id="btnExport" title="Export JSON"><svg class="icon"><use href="#i-download"/></svg></button>
            <button class="btn icon-btn" id="btnTheme" title="Toggle theme"><svg class="icon" id="themeIcon"><use href="#i-moon"/></svg></button>
            <div class="menu" id="settingsMenu">
              <button class="btn icon-btn" id="btnSettings" title="Settings"><svg class="icon"><use href="#i-settings"/></svg></button>
              <div class="menu-list panel">
                <div class="side-title" style="margin:6px 6px 4px">Settings</div>
                <button class="menu-item" id="miLock">Lock Now</button>
                <button class="menu-item" id="miExport">Export Data</button>
                <hr class="menu-sep" />
                <button class="menu-item danger" id="miResetAll">Reset App (All)</button>
                <button class="menu-item" id="miResetEntries">Reset Entries Only</button>
                <button class="menu-item" id="miResetLogin">Reset Login Only</button>
              </div>
            </div>
            <button class="btn primary" id="btnNew"><svg class="icon"><use href="#i-plus"/></svg> New Entry</button>
          </div>
        </div>
      </div>

      <div class="content">
        <aside class="sidebar panel">
          <div class="side-section">
            <div class="side-title">Entries</div>
            <div class="entries-list" id="entryList"></div>
          </div>
        </aside>

        <main class="main">
          <div class="toolbar">
            <div class="summary" id="summary"></div>
            <div class="chips" id="activeFilters"></div>
          </div>
          <div class="panel" style="padding: 14px;">
            <div class="grid" id="grid"></div>
            <div id="emptyState" class="empty" style="display:none">
              <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">No entries yet</div>
              <div>Click “New Entry” to write your first note.</div>
            </div>
          </div>
        </main>

        <aside class="rightbar panel">
          <div class="side-section">
            <div class="side-title">Calendar</div>
            <div class="calendar">
              <div class="cal-header">
                <button id="calPrev" title="Previous month">‹</button>
                <div id="calLabel" style="font-weight:600"></div>
                <button id="calNext" title="Next month">›</button>
              </div>
              <div class="cal-grid" id="calDays"></div>
            </div>
          </div>
          <div class="side-section">
            <div class="side-title">Tags</div>
            <div class="chips" id="tagChips"></div>
          </div>
          <div class="side-section">
            <div class="side-title">Mood</div>
            <div class="chips" id="moodChips"></div>
          </div>
        </aside>
      </div>
    </div>

    <!-- Editor Modal -->
    <div class="modal" id="editorModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="overlay" data-close></div>
      <div class="dialog">
        <header style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div style="display:flex; align-items:center; gap:10px;">
            <svg class="icon"><use href="#i-calendar"/></svg>
            <div style="font-weight:700">Entry Editor</div>
          </div>
          <button class="btn icon-btn" data-close title="Close"><svg class="icon"><use href="#i-close"/></svg></button>
        </header>
        <div class="editor">
          <section>
            <div class="field">
              <label for="titleInput">Title</label>
              <input id="titleInput" type="text" placeholder="Give your entry a title" />
            </div>
            <div class="field" style="margin-top:10px">
              <label>Content</label>
              <div class="formatbar">
                <button data-cmd="bold" title="Bold"><svg class="icon"><use href="#i-bold"/></svg></button>
                <button data-cmd="italic" title="Italic"><svg class="icon"><use href="#i-italic"/></svg></button>
                <button data-cmd="underline" title="Underline"><svg class="icon"><use href="#i-underline"/></svg></button>
                <button data-cmd="insertUnorderedList" title="Bulleted list"><svg class="icon"><use href="#i-list"/></svg></button>
                <button data-cmd="insertOrderedList" title="Numbered list"><svg class="icon"><use href="#i-olist"/></svg></button>
                <button id="btnLink" title="Insert link"><svg class="icon"><use href="#i-link"/></svg></button>
                <button data-cmd="undo" title="Undo"><svg class="icon"><use href="#i-close"/></svg></button>
              </div>
              <div class="contenteditable" id="contentEditable" contenteditable="true" spellcheck="true"></div>
              <div class="help">Tip: Use Ctrl/Cmd + B/I/U for formatting. Links auto-detected.</div>
            </div>
          </section>
          <aside class="rightcol">
            <div class="field">
              <label for="dateInput">Date</label>
              <input id="dateInput" type="date" />
            </div>
            <div class="field">
              <label>Mood</label>
              <div class="moods" id="moodPick"></div>
            </div>
            <div class="field">
              <label for="tagsInput">Tags</label>
              <input id="tagsInput" type="text" placeholder="Comma separated (e.g., work, ideas)" />
              <div class="chips" id="tagsPreview"></div>
            </div>
            <div class="field">
              <label for="pinInput">Pin</label>
              <div>
                <input id="pinInput" type="checkbox" /> Pin this entry
              </div>
            </div>
          </aside>
        </div>
        <footer>
          <button class="btn ghost" data-close>Cancel</button>
          <button class="btn" id="btnDelete" style="margin-right:auto; display:none"><svg class="icon"><use href="#i-trash"/></svg> Delete</button>
          <button class="btn primary" id="btnSave">Save</button>
        </footer>
      </div>
    </div>

    <input type="file" id="fileInput" accept="application/json" style="display:none" />
    <div class="toast" id="toast"></div>

    <!-- About / Getting Started -->
    <div class="panel" style="max-width:960px;margin:24px auto;padding:16px 18px;">
      <h2 style="margin:0 0 8px;">About</h2>
      <div style="color:var(--muted);margin-bottom:10px;">
        This is a simple, client‑side diary app. Your entries are stored in your browser’s local storage under your user.
      </div>
      <h3 style="margin:12px 0 6px;">Getting Started</h3>
      <ol style="margin:0;padding-left:18px;color:var(--muted)">
        <li>Create a username and password to unlock.</li>
        <li>Click “New Entry” to write your first note.</li>
        <li>Use Export/Import in Settings to back up or restore.</li>
      </ol>
    </div>

    <script>
      // Utilities
      const qs = (sel, el=document) => el.querySelector(sel);
      const qsa = (sel, el=document) => [...el.querySelectorAll(sel)];
      const fmtDate = (d) => {
        const re = /^(\d{4})-(\d{2})-(\d{2})$/;
        let dt = null;
        const m = typeof d === 'string' && d.match(re);
        if (m) dt = new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
        else dt = new Date(d);
        return dt.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
      };
      const ymd = (dt) => {
        const y = dt.getFullYear();
        const m = String(dt.getMonth() + 1).padStart(2, '0');
        const d = String(dt.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      };
      const isoFromYMD = (y, m, d) => `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const todayISO = () => ymd(new Date());
      const uid = () => crypto?.randomUUID ? crypto.randomUUID() : 'id-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
      const saveLS = (k, v) => localStorage.setItem(k, JSON.stringify(v));
      const loadLS = (k, def) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; } catch { return def; } };
      const debounce = (fn, ms=300) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); } };

      // Storage keys
      const STORAGE_KEY = 'daybook.entries.v1'; // legacy single-user entries key
      const SETTINGS_KEY = 'daybook.settings.v1';
      const AUTH_KEY = 'daybook.auth.v1'; // legacy single-user auth key
      const USERS_KEY = 'daybook.users.v1';
      const CUR_USER_KEY = 'daybook.currentUser.v1';

      // State
      let entries = [];
      let settings = loadLS(SETTINGS_KEY, { theme: (window.matchMedia && matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light' });
      let users = loadLS(USERS_KEY, {});
      let currentUser = loadLS(CUR_USER_KEY, null);
      let unlocked = false;
      let filters = { q: '', tags: new Set(), mood: null, date: null };
      let calState = { year: new Date().getFullYear(), month: new Date().getMonth() };
      let editingId = null;

      // Elements
      const elToday = qs('#todayLabel');
      const elSearch = qs('#searchInput');
      const elGrid = qs('#grid');
      const elEmpty = qs('#emptyState');
      const elSummary = qs('#summary');
      const elTagChips = qs('#tagChips');
      const elMoodChips = qs('#moodChips');
      const elActiveFilters = qs('#activeFilters');
      const elToast = qs('#toast');
      const elThemeIcon = qs('#themeIcon');
      const elEntryList = qs('#entryList');

      // Auth elements
      const authGate = qs('#authGate');
      const loginView = qs('#loginView');
      const setupView = qs('#setupView');
      const authSubtitle = qs('#authSubtitle');
      const authError = qs('#authError');
      const setupError = qs('#setupError');
      const loginUser = qs('#loginUser');
      const loginPass = qs('#loginPass');
      const setupUser = qs('#setupUser');
      const setupPass = qs('#setupPass');
      const setupPass2 = qs('#setupPass2');
      const usersList = qs('#usersList');
      const goSetup = qs('#goSetup');
      const goLogin = qs('#goLogin');

      // Editor elements
      const modal = qs('#editorModal');
      const titleInput = qs('#titleInput');
      const contentEditable = qs('#contentEditable');
      const dateInput = qs('#dateInput');
      const moodPick = qs('#moodPick');
      const tagsInput = qs('#tagsInput');
      const tagsPreview = qs('#tagsPreview');
      const pinInput = qs('#pinInput');
      const btnDelete = qs('#btnDelete');

      // Settings menu elements
      const settingsMenu = qs('#settingsMenu');
      const btnSettings = qs('#btnSettings');
      const miLock = qs('#miLock');
      const miExport = qs('#miExport');
      const miResetAll = qs('#miResetAll');
      const miResetEntries = qs('#miResetEntries');
      const miResetLogin = qs('#miResetLogin');

      const MOODS = [
        { key:'joy', label:'😊 Joy' },
        { key:'calm', label:'😌 Calm' },
        { key:'ok',   label:'😐 Neutral' },
        { key:'sad',  label:'😔 Sad' },
        { key:'angry',label:'😡 Angry' },
        { key:'wow',  label:'🤩 Excited' },
      ];

      // Theme
      function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        elThemeIcon.firstElementChild?.setAttribute('href', theme === 'dark' ? '#i-sun' : '#i-moon');
      }
      applyTheme(settings.theme);

      // Today label
      elToday.textContent = new Date().toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric' });

      // Settings menu behavior
      btnSettings.addEventListener('click', (e) => { e.stopPropagation(); settingsMenu.classList.toggle('open'); });
      document.addEventListener('click', () => settingsMenu.classList.remove('open'));

      // Render calendar
      function buildCalendar() {
        const elLabel = qs('#calLabel');
        const elDays = qs('#calDays');
        const { year, month } = calState;
        const first = new Date(year, month, 1);
        const startDay = (first.getDay() + 6) % 7; // Monday=0
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const prevDays = new Date(year, month, 0).getDate();
        elLabel.textContent = first.toLocaleDateString(undefined, { month:'long', year:'numeric' });
        elDays.innerHTML = '';

        const weekNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        weekNames.forEach(n => {
          const d = document.createElement('div'); d.className = 'cal-day'; d.textContent = n; elDays.appendChild(d);
        });

        const totalCells = 42; // 6 weeks
        const countsByDate = new Map();
        entries.forEach(e => { const iso = e.date; countsByDate.set(iso, (countsByDate.get(iso) || 0) + 1); });
        for (let i = 0; i < totalCells; i++) {
          const cell = document.createElement('div'); cell.className = 'cal-cell';
          let dayNum, cellMonth = month, cellYear = year;
          if (i < startDay) { // prev month
            dayNum = prevDays - (startDay - 1 - i); cellMonth = month - 1; if (cellMonth < 0) { cellMonth = 11; cellYear = year - 1; }
            cell.classList.add('out');
          } else if (i >= startDay + daysInMonth) { // next month
            dayNum = i - (startDay + daysInMonth) + 1; cellMonth = month + 1; if (cellMonth > 11) { cellMonth = 0; cellYear = year + 1; }
            cell.classList.add('out');
          } else { // this month
            dayNum = i - startDay + 1;
          }
          const iso = isoFromYMD(cellYear, cellMonth + 1, dayNum);
          cell.textContent = String(dayNum);
          if (countsByDate.has(iso)) cell.classList.add('has');
          if (filters.date === iso) cell.classList.add('active');
          cell.title = `Filter: ${fmtDate(iso)}`;
          cell.addEventListener('click', () => { filters.date = iso; render(); });
          elDays.appendChild(cell);
        }
      }
      qs('#calPrev').addEventListener('click', () => { calState.month--; if (calState.month < 0) { calState.month = 11; calState.year--; } buildCalendar(); });
      qs('#calNext').addEventListener('click', () => { calState.month++; if (calState.month > 11) { calState.month = 0; calState.year++; } buildCalendar(); });

      // Tags + moods chips
      function renderFilterChips() {
        // Tags list with counts
        const counts = new Map();
        entries.forEach(e => (e.tags||[]).forEach(t => counts.set(t, (counts.get(t)||0)+1)));
        const tags = [...counts.keys()].sort((a,b)=>a.localeCompare(b));
        elTagChips.innerHTML = '';
        if (!tags.length) {
          elTagChips.innerHTML = '<div class="help">No tags yet</div>';
        } else {
          tags.forEach(t => {
            const chip = document.createElement('button'); chip.className = 'chip';
            if (filters.tags.has(t)) chip.classList.add('active');
            chip.innerHTML = `<svg class="icon"><use href="#i-tag"/></svg> <span>${t}</span> <span class="count">${counts.get(t)}</span>`;
            chip.addEventListener('click', () => { filters.tags.has(t) ? filters.tags.delete(t) : filters.tags.add(t); render(); });
            elTagChips.appendChild(chip);
          });
        }

        // Mood chips
        elMoodChips.innerHTML = '';
        MOODS.forEach(m => {
          const chip = document.createElement('button'); chip.className = 'chip';
          const emoji = m.label.split(' ')[0];
          if (filters.mood === m.key) chip.classList.add('active');
          chip.innerHTML = `${emoji} <span>${m.label.split(' ').slice(1).join(' ')}</span>`;
          chip.title = `Filter: ${m.label}`;
          chip.addEventListener('click', () => { filters.mood = (filters.mood === m.key) ? null : m.key; render(); });
          elMoodChips.appendChild(chip);
        });
      }

      // Active filters display
      function renderActiveFilters() {
        elActiveFilters.innerHTML = '';
        const chips = [];
        if (filters.q) chips.push({ label: `Search: "${filters.q}"`, clear: () => { filters.q = ''; elSearch.value=''; } });
        if (filters.date) chips.push({ label: fmtDate(filters.date), clear: () => filters.date = null });
        if (filters.mood) {
          const mood = MOODS.find(m=>m.key===filters.mood); chips.push({ label: mood?.label || filters.mood, clear: () => filters.mood=null });
        }
        [...filters.tags].forEach(t => chips.push({ label: `#${t}`, clear: () => filters.tags.delete(t) }));
        chips.forEach(c => {
          const el = document.createElement('button'); el.className = 'chip active';
          el.innerHTML = `${c.label} <svg class="icon"><use href="#i-close"/></svg>`;
          el.addEventListener('click', () => { c.clear(); render(); });
          elActiveFilters.appendChild(el);
        });
        if (!chips.length) {
          const el = document.createElement('div'); el.className = 'help'; el.textContent = 'No active filters'; elActiveFilters.appendChild(el);
        }
      }

      // Render entries list
      function renderList() {
        const q = filters.q.trim().toLowerCase();
        const tagFilter = filters.tags;
        const mood = filters.mood;
        const date = filters.date;
        const filtered = entries.filter(e => {
          if (q) {
            const hay = (e.title + ' ' + (e.bodyText || '') + ' ' + (e.tags||[]).join(' ')).toLowerCase();
            if (!hay.includes(q)) return false;
          }
          if (tagFilter.size) {
            const tags = new Set(e.tags || []);
            for (const t of tagFilter) if (!tags.has(t)) return false;
          }
          if (mood && e.mood !== mood) return false;
          if (date && e.date !== date) return false;
          return true;
        }).sort((a,b) => (b.pinned - a.pinned) || b.updatedAt - a.updatedAt);

        elSummary.textContent = `${filtered.length} entr${filtered.length===1?'y':'ies'}${q||tagFilter.size||mood||date ? ' (filtered)' : ''}`;

        elGrid.innerHTML = '';
        elEmpty.style.display = entries.length ? 'none' : 'block';
        if (!filtered.length && entries.length) {
          elGrid.innerHTML = '<div class="empty">No entries match your filters.</div>';
          return;
        }

        filtered.forEach(e => {
          const card = document.createElement('article'); card.className = 'card'; card.dataset.id = e.id;
          const moodEmoji = (MOODS.find(m=>m.key===e.mood)?.label || '😐').split(' ')[0];
          card.innerHTML = `
            ${e.pinned ? `<div class="pin">📌</div>` : ''}
            <div class="card-actions">
              <button class="btn icon-btn small" data-action="pin" title="${e.pinned?'Unpin':'Pin'}"><svg class="icon"><use href="#i-pin"/></svg></button>
              <button class="btn icon-btn small" data-action="edit" title="Edit"><svg class="icon"><use href="#i-edit"/></svg></button>
              <button class="btn icon-btn small" data-action="delete" title="Delete"><svg class="icon"><use href="#i-trash"/></svg></button>
            </div>
            <h3 class="title">${escapeHtml(e.title) || '(Untitled)'}</h3>
            <div class="meta">${moodEmoji} <span>•</span> <span>${fmtDate(e.date)}</span></div>
            <div class="body">${truncateHtml(e.body || '', 360)}</div>
            <div class="tags">${(e.tags||[]).map(t => `<span class="tag-mini">#${escapeHtml(t)}</span>`).join('')}</div>
          `;
          card.addEventListener('click', (ev) => {
            const actionBtn = ev.target.closest('[data-action]');
            if (actionBtn) return; // handled below
            openEditor(e.id);
          });
          card.querySelector('[data-action="edit"]').addEventListener('click', () => openEditor(e.id));
          card.querySelector('[data-action="delete"]').addEventListener('click', () => deleteEntry(e.id));
          card.querySelector('[data-action="pin"]').addEventListener('click', () => togglePin(e.id));
          elGrid.appendChild(card);
        });
      }

      // Left-side entries list (titles)
      function renderEntryList() {
        if (!elEntryList) return;
        const items = entries.filter(e => (e.title||'').trim().length);
        if (!items.length) {
          elEntryList.innerHTML = '<div class="help">No titled entries yet</div>';
          return;
        }
        const pinned = items.filter(e => e.pinned).sort((a,b)=> b.updatedAt - a.updatedAt);
        const rest = items.filter(e => !e.pinned).sort((a,b)=> b.updatedAt - a.updatedAt);
        const groups = new Map();
        rest.forEach(e => {
          const key = (e.date||'').slice(0,7) || 'unknown';
          if (!groups.has(key)) groups.set(key, []);
          groups.get(key).push(e);
        });
        const keys = [...groups.keys()].sort().reverse();
        let html = '';
        if (pinned.length) {
          html += '<div class="entry-group">Pinned</div>';
          html += pinned.map(e => entryItemHtml(e, true)).join('');
        }
        keys.forEach(k => {
          const dt = k!=='unknown' ? new Date(k+'-01') : null;
          const label = dt ? dt.toLocaleDateString(undefined, { month:'long', year:'numeric' }) : 'Other';
          html += `<div class="entry-group">${label}</div>`;
          html += (groups.get(k)||[]).map(e => entryItemHtml(e, false)).join('');
        });
        elEntryList.innerHTML = html;
        // Bind clicks
        elEntryList.querySelectorAll('.entry-item').forEach(node => {
          node.addEventListener('click', () => {
            const id = node.getAttribute('data-id');
            if (!unlocked) return; // ignore while locked
            openEditor(id);
          });
        });
        function entryItemHtml(e, isPinned) {
          const moodEmoji = (MOODS.find(m=>m.key===e.mood)?.label || '😐').split(' ')[0];
          return `<div class="entry-item" data-id="${e.id}">
            <div class="t">${escapeHtml(e.title)}</div>
            <div class="m">${isPinned?'📌':''} ${moodEmoji} • ${fmtDate(e.date)}</div>
          </div>`;
        }
      }

      function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
      function truncateHtml(html, maxChars) {
        const tmp = document.createElement('div'); tmp.innerHTML = html; const text = tmp.textContent || '';
        return escapeHtml(text.length > maxChars ? text.slice(0, maxChars) + '…' : text);
      }

      // Editor
      function openEditor(id=null) {
        editingId = id;
        const isNew = !id;
        const entry = entries.find(e=>e.id===id) || { id: uid(), title:'', body:'', bodyText:'', date: todayISO(), mood: 'ok', tags: [], pinned: false, createdAt: Date.now(), updatedAt: Date.now() };
        titleInput.value = entry.title || '';
        contentEditable.innerHTML = entry.body || '';
        dateInput.value = entry.date || todayISO();
        pinInput.checked = !!entry.pinned;
        tagsInput.value = (entry.tags||[]).join(', ');
        renderTagsPreview();
        renderMoodPick(entry.mood);
        btnDelete.style.display = isNew ? 'none' : 'inline-flex';
        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');
        setTimeout(()=> titleInput.focus(), 50);
      }
      function closeEditor() {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden','true');
        editingId = null;
      }
      qsa('[data-close]', modal).forEach(el => el.addEventListener('click', closeEditor));

      // Format bar with execCommand (simple and widely supported)
      qsa('.formatbar [data-cmd]').forEach(btn => btn.addEventListener('click', () => {
        document.execCommand(btn.dataset.cmd, false);
        contentEditable.focus();
      }));
      qs('#btnLink').addEventListener('click', () => {
        const url = prompt('Enter URL'); if (!url) return;
        document.execCommand('createLink', false, url);
        contentEditable.focus();
      });

      function renderMoodPick(active='ok') {
        moodPick.innerHTML = '';
        MOODS.forEach(m => {
          const b = document.createElement('button'); b.className = 'mood';
          const emoji = m.label.split(' ')[0];
          if (m.key === active) b.classList.add('active');
          b.textContent = `${emoji}`;
          b.title = m.label;
          b.addEventListener('click', () => { qsa('.mood', moodPick).forEach(el=>el.classList.remove('active')); b.classList.add('active'); b.dataset.active='true'; b.dataset.key = m.key; moodPick.dataset.value = m.key; });
          b.dataset.key = m.key;
          moodPick.appendChild(b);
        });
        moodPick.dataset.value = active;
      }

      function parseTags(str) {
        return (str||'')
          .split(',')
          .map(t => t.trim())
          .filter(Boolean)
          .slice(0, 20);
      }
      function renderTagsPreview() {
        tagsPreview.innerHTML = '';
        parseTags(tagsInput.value).forEach(t => {
          const s = document.createElement('span'); s.className='tag-mini'; s.textContent = '#' + t; tagsPreview.appendChild(s);
        });
      }
      tagsInput.addEventListener('input', debounce(renderTagsPreview, 100));

      function collectEditorData() {
        const title = titleInput.value.trim();
        const body = contentEditable.innerHTML;
        const bodyText = contentEditable.textContent || '';
        const date = dateInput.value || todayISO();
        const mood = moodPick.dataset.value || 'ok';
        const tags = parseTags(tagsInput.value);
        const pinned = !!pinInput.checked;
        return { title, body, bodyText, date, mood, tags, pinned };
      }

      function saveEntry() {
        const data = collectEditorData();
        const now = Date.now();
        if (editingId) {
          const idx = entries.findIndex(e=>e.id===editingId); if (idx>-1) {
            entries[idx] = { ...entries[idx], ...data, updatedAt: now };
          }
        } else {
          entries.push({ id: uid(), ...data, createdAt: now, updatedAt: now });
        }
        persist();
        closeEditor();
        toast('Saved');
      }
      qs('#btnSave').addEventListener('click', saveEntry);
      btnDelete.addEventListener('click', () => { if (!editingId) return; if (!confirm('Delete this entry?')) return; deleteEntry(editingId); closeEditor(); });

      function deleteEntry(id) {
        const i = entries.findIndex(e=>e.id===id); if (i>-1) { entries.splice(i,1); persist(); toast('Deleted'); }
      }
      function togglePin(id) { const e = entries.find(e=>e.id===id); if (!e) return; e.pinned = !e.pinned; e.updatedAt = Date.now(); persist(false); render(); }

      // Search
      elSearch.addEventListener('input', debounce(() => { filters.q = elSearch.value; render(); }, 150));
      window.addEventListener('keydown', (e) => {
        if (!unlocked) return;
        if (e.key === '/' && document.activeElement !== elSearch) { e.preventDefault(); elSearch.focus(); elSearch.select(); }
        if ((e.key === 'n' || e.key === 'N') && !e.metaKey && !e.ctrlKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.contentEditable !== 'true') { e.preventDefault(); openEditor(); }
      });

      // Import/Export
      function doExport() {
        const data = { entries, exportedAt: new Date().toISOString(), app: 'Daybook v1' };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'daybook-export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
        toast('Exported');
      }
      qs('#btnExport').addEventListener('click', doExport);
      const fileInput = qs('#fileInput');
      qs('#btnImport').addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', () => {
        const f = fileInput.files?.[0]; if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const obj = JSON.parse(String(reader.result||'{}'));
            if (!obj || !Array.isArray(obj.entries)) throw new Error('Invalid file');
            if (!confirm('Import will replace your current entries. Continue?')) return;
            entries = obj.entries.map(e => ({ ...e, createdAt: e.createdAt || Date.now(), updatedAt: e.updatedAt || Date.now() }));
            persist();
            toast('Imported');
          } catch (err) { toast('Import failed'); console.error(err); }
        };
        reader.readAsText(f);
        fileInput.value = '';
      });

      // Theme toggle
      function toggleTheme() { settings.theme = (settings.theme === 'dark') ? 'light' : 'dark'; persistSettings(); applyTheme(settings.theme); }
      qs('#btnTheme').addEventListener('click', toggleTheme);

      // Lock Now
      function lockNow() {
        unlocked = false;
        document.body.classList.add('locked');
        authGate.style.display = '';
        if (Object.keys(users).length) setAuthMode('login'); else setAuthMode('setup');
        toast('Locked');
      }

      // Reset helpers
      function confirmTypedReset(message) {
        if (!confirm(message)) return false;
        const typed = prompt('Type RESET to confirm');
        return typed === 'RESET';
      }
      function resetAll() {
        if (!confirmTypedReset('Reset ALL data? This clears entries, settings, and login.')) return;
        // Remove all user entries
        for (const u of Object.keys(users)) {
          localStorage.removeItem(`daybook.entries.${encodeURIComponent(u)}.v1`);
        }
        // Remove keys
        localStorage.removeItem(STORAGE_KEY); // legacy
        localStorage.removeItem(AUTH_KEY); // legacy
        localStorage.removeItem(USERS_KEY);
        localStorage.removeItem(CUR_USER_KEY);
        localStorage.removeItem(SETTINGS_KEY);
        // Reset state
        entries = [];
        users = {};
        currentUser = null;
        settings = { theme: (window.matchMedia && matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light' };
        applyTheme(settings.theme);
        lockNow();
        toast('App reset');
      }
      function resetEntriesOnly() {
        if (!confirmTypedReset('Reset entries only? Your notes will be erased.')) return;
        if (!currentUser) { toast('No user active'); return; }
        localStorage.removeItem(`daybook.entries.${encodeURIComponent(currentUser)}.v1`);
        entries = [];
        render();
        toast('Entries cleared');
      }
      function resetLoginOnly() {
        if (!confirmTypedReset('Reset login only? You will need to create a new password.')) return;
        if (!currentUser) { toast('No user active'); return; }
        // Remove login for current user
        delete users[currentUser];
        saveLS(USERS_KEY, users);
        // Keep entries for current user, but require creating a new password
        const lastUser = currentUser;
        currentUser = null;
        localStorage.removeItem(CUR_USER_KEY);
        lockNow();
        // Pre-fill setup username with last user name for convenience
        setTimeout(() => { if (document.body.classList.contains('locked')) { setAuthMode('setup'); const su = document.getElementById('setupUser'); if (su) su.value = lastUser; } }, 0);
        toast('Login reset');
      }

      // Settings menu items
      miLock.addEventListener('click', () => { settingsMenu.classList.remove('open'); lockNow(); });
      miExport.addEventListener('click', () => { settingsMenu.classList.remove('open'); doExport(); });
      miResetAll.addEventListener('click', () => { settingsMenu.classList.remove('open'); resetAll(); });
      miResetEntries.addEventListener('click', () => { settingsMenu.classList.remove('open'); resetEntriesOnly(); });
      miResetLogin.addEventListener('click', () => { settingsMenu.classList.remove('open'); resetLoginOnly(); });

      // Persistence
      function persist(shouldRender = true) { if (!currentUser) return; saveLS(entriesKey(currentUser), entries); if (shouldRender) render(); }
      function persistSettings() { saveLS(SETTINGS_KEY, settings); }

      // Toast
      let toastTimer;
      function toast(msg) {
        elToast.textContent = msg; elToast.classList.add('show'); clearTimeout(toastTimer); toastTimer = setTimeout(()=> elToast.classList.remove('show'), 1600);
      }

      // New button
      qs('#btnNew').addEventListener('click', () => { if (!unlocked) return; openEditor(); });

      // Render pipeline
      function render() {
        buildCalendar();
        renderEntryList();
        renderFilterChips();
        renderActiveFilters();
        renderList();
      }

      // ============ Auth (Client-side gate) ============
      const ITERATIONS = 150000;
      const enc = new TextEncoder();
      function b64enc(bytes) { let bin = ''; bytes.forEach(b=> bin += String.fromCharCode(b)); return btoa(bin); }
      function b64dec(str) { const bin = atob(str||''); const out = new Uint8Array(bin.length); for (let i=0;i<bin.length;i++) out[i]=bin.charCodeAt(i); return out; }
      async function derive(password, saltB64, iterations=ITERATIONS) {
        const salt = typeof saltB64 === 'string' ? b64dec(saltB64) : saltB64;
        const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits']);
        const bits = await crypto.subtle.deriveBits({ name:'PBKDF2', salt, iterations, hash:'SHA-256' }, keyMaterial, 256);
        return new Uint8Array(bits);
      }
      function entriesKey(user) { return `daybook.entries.${encodeURIComponent(user)}.v1`; }
      function renderUsersList() {
        usersList.innerHTML = Object.keys(users).sort().map(u => `<option value="${escapeHtml(u)}"></option>`).join('');
      }
      function setAuthMode(mode) {
        if (mode === 'login') {
          loginView.style.display = 'block';
          setupView.style.display = 'none';
          authSubtitle.textContent = 'Sign in to your diary';
          renderUsersList();
          setTimeout(()=> loginUser.focus(), 50);
        } else {
          loginView.style.display = 'none';
          setupView.style.display = 'block';
          authSubtitle.textContent = 'Create a username and password';
          setTimeout(()=> setupUser.focus(), 50);
        }
      }
      function unlockApp() {
        unlocked = true;
        document.body.classList.remove('locked');
        authGate.style.display = 'none';
        // Load entries for current user
        entries = loadLS(entriesKey(currentUser), []);
        render();
      }
      // Setup submit
      setupView.addEventListener('submit', async (e) => {
        e.preventDefault(); setupError.textContent = '';
        const user = (setupUser.value||'').trim();
        const p1 = setupPass.value || '';
        const p2 = setupPass2.value || '';
        if (user.length < 2) { setupError.textContent = 'Username must be at least 2 characters.'; return; }
        if (p1.length < 6) { setupError.textContent = 'Password must be at least 6 characters.'; return; }
        if (p1 !== p2) { setupError.textContent = 'Passwords do not match.'; return; }
        if (users[user]) { setupError.textContent = 'Username already exists. Please sign in.'; return; }
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const hash = await derive(p1, salt, ITERATIONS);
        users[user] = { salt: b64enc(salt), hash: b64enc(hash), iter: ITERATIONS, kdf: 'PBKDF2-SHA256' };
        saveLS(USERS_KEY, users);
        currentUser = user; saveLS(CUR_USER_KEY, currentUser);
        unlockApp();
        toast('Welcome');
      });
      // Login submit
      loginView.addEventListener('submit', async (e) => {
        e.preventDefault(); authError.textContent = '';
        const user = (loginUser.value||'').trim();
        const pass = loginPass.value || '';
        if (!users[user]) { authError.textContent = 'User not found.'; return; }
        try {
          const rec = users[user];
          const calc = await derive(pass, rec.salt, rec.iter || ITERATIONS);
          const ok = b64enc(calc) === rec.hash;
          if (!ok) { authError.textContent = 'Invalid username or password.'; return; }
          currentUser = user; saveLS(CUR_USER_KEY, currentUser);
          unlockApp();
          toast('Unlocked');
        } catch (err) {
          console.error(err); authError.textContent = 'Error while verifying password.';
        }
      });

      // Initialize auth mode
      // Migration from legacy single-user auth/entries
      (function migrateLegacy(){
        const legacyAuth = loadLS(AUTH_KEY, null);
        const legacyEntries = loadLS(STORAGE_KEY, null);
        if (legacyAuth && legacyAuth.user && !users[legacyAuth.user]) {
          users[legacyAuth.user] = { salt: legacyAuth.salt, hash: legacyAuth.hash, iter: legacyAuth.iter || ITERATIONS, kdf: 'PBKDF2-SHA256' };
          saveLS(USERS_KEY, users);
        }
        if (legacyAuth && legacyAuth.user && Array.isArray(legacyEntries)) {
          saveLS(entriesKey(legacyAuth.user), legacyEntries);
          localStorage.removeItem(STORAGE_KEY);
        }
        if (legacyAuth) localStorage.removeItem(AUTH_KEY);
      })();

      // Initialize auth mode
      if (Object.keys(users).length) {
        setAuthMode('login');
        if (currentUser && users[currentUser]) loginUser.value = currentUser;
      } else {
        setAuthMode('setup');
      }
      goSetup?.addEventListener('click', () => setAuthMode('setup'));
      goLogin?.addEventListener('click', () => setAuthMode('login'));
    </script>
  </body>
  </html>
